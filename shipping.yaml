  - name: "set up for shipping server"
    hosts: shipping
    become: yes
    tasks:
      - name: "install maven"
        ansible.builtin.dnf:
          name: "{{ item }}"
          state: present
        loop:
         - maven
         - mysql

      - name: create system user
        ansible.builtin.user:
          name: roboshop
          comment: roboshop system user
          home: /app
          shell: /sbin/nologin

      - name: delete app directory
        ansible.builtin.file:
          path: /app
          state: absent
      - name: create app directory
        ansible.builtin.file:
          path: /app
          state: directory

      - name: Delete catalogue file
        ansible.builtin.file:
          path: /tmp/catalogue.zip
          state: absent

      - name: download shipping code
        ansible.builtin.get_url:
          url: https://roboshop-artifacts.s3.amazonaws.com/shipping-v3.zip 
          dest: /tmp/shipping.zip

      - name: unzip shipping code in /app
        ansible.builtin.unarchive:
          src: /tmp/shipping.zip
          dest: /app
          remote_src: yes
      - name: install dependencies
        ansible.builtin.command: mvn clean package 
        args:
         chdir: /app
      - name: copy shipping service
        ansible.builtin.copy:
          src: shipping.service
          dest: /etc/systemd/system/shipping.service

      - name: import shipping data into mysql
        community.mysql.mysql_db:
         state: import
         name: all
         login_host: mysql.saws86s.fun
         login_user: root
         login_password: RoboShop@1
         target: "{{ item }}"
        loop:
        - /app/db/schema.sql
        - /app/db/app-user.sql 
        - /app/db/master-data.sql

      - name: start,enable and daemon_reload
        ansible.builtin.service:
          name: shipping
          state: started
          daemon_reload: true

